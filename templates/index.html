<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Turbo YouTube Player + History</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { margin:0; background:#000; color:#fff; font-family:Arial; text-align:center; padding:20px; }
        h1 { color:#ff0000; }
        .input-box { margin:30px; }
        input { width:68%; padding:16px; font-size:18px; border:none; border-radius:12px 0 0 12px; }
        button.go { padding:16px 30px; background:#ff0000; color:white; border:none; border-radius:0 12px 12px 0; font-size:18px; cursor:pointer; }
        button.go:hover { background:#cc0000; }

        .video-box { position:relative; max-width:960px; margin:30px auto; border-radius:16px; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,0.8); display:none; background:#000; }
        video { width:100%; }

        .bigplay { position:absolute; top:50%; left:50%; width:110px; height:110px; background:rgba(255,255,255,0.95); border-radius:50%; transform:translate(-50%,-50%); cursor:pointer; z-index:10; }
        .bigplay:after { content:''; position:absolute; top:50%; left:55%; transform:translate(-50%,-50%); border-left:34px solid #ff0000; border-top:22px solid transparent; border-bottom:22px solid transparent; }
        .bigplay:hover { transform:translate(-50%,-50%) scale(1.2); }

        .speed-bar { margin:20px; padding:15px; background:rgba(255,255,255,0.1); border-radius:12px; display:none; }
        .spd { background:rgba(255,255,255,0.2); color:white; border:none; padding:10px 18px; margin:5px; border-radius:8px; cursor:pointer; font-weight:bold; }
        .spd:hover, .spd.active { background:#ff0000; }

        .history { margin:40px auto; max-width:960px; background:rgba(255,255,255,0.05); border-radius:12px; padding:20px; }
        table { width:100%; border-collapse:collapse; margin-top:10px; }
        th, td { padding:12px; text-align:left; border-bottom:1px solid rgba(255,255,255,0.1); }
        th { background:rgba(255,0,0,0.3); }
        tr:hover { background:rgba(255,255,255,0.1); }
        .play-small { background:#ff0000; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:14px; }
        .play-small:hover { background:#cc0000; }
        .clear-btn { background:#333; color:white; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; margin-top:15px; }

        .status { font-size:20px; margin:20px; min-height:30px; color:#0f0; }
    </style>
</head>
<body>
    <h1>Turbo YouTube Player</h1>
    <p>Paste any link → instant play + history</p>

    <div class="input-box">
        <input type="text" id="url" placeholder="https://youtu.be/..." autofocus>
        <button class="go" onclick="load()">Play</button>
    </div>

    <div id="box" class="video-box">
        <div id="playbtn" class="bigplay" onclick="vid.play(); this.style.opacity=0;"></div>
        <video id="vid" controls preload="none"></video>
    </div>

    <div id="speeds" class="speed-bar">
        <button class="spd active" onclick="set(1)">1×</button>
        <button class="spd" onclick="set(2.5)">2.5×</button>
        <button class="spd" onclick="set(3)">3×</button>
        <button class="spd" onclick="set(3.5)">3.5×</button>
        <button class="spd" onclick="set(4)">4×</button>
    </div>

    <div id="msg" class="status"></div>
    <h2 id="title"></h2>

    <!-- Recent Links Table -->
    <div class="history">
        <h2>Recent Links</h2>
        <table id="historyTable">
            <thead>
                <tr><th>Title</th><th>Link</th><th>Action</th></tr>
            </thead>
            <tbody></tbody>
        </table>
        <button class="clear-btn" onclick="clearHistory()">Clear History</button>
    </div>

    <script>
        const vid = document.getElementById('vid');
        const box = document.getElementById('box');
        const playbtn = document.getElementById('playbtn');
        const speeds = document.getElementById('speeds');
        const msg = document.getElementById('msg');
        const titleEl = document.getElementById('title');
        const tableBody = document.querySelector('#historyTable tbody');

        // Load history from localStorage
        let history = JSON.parse(localStorage.getItem('ytHistory') || '[]');
        renderHistory();

        function set(speed) {
            vid.playbackRate = speed;
            document.querySelectorAll('.spd').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        function saveToHistory(title, url) {
            // Avoid duplicates
            history = history.filter(h => h.url !== url);
            history.unshift({ title, url, time: new Date().toLocaleString() });
            if (history.length > 20) history.pop();
            localStorage.setItem('ytHistory', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            tableBody.innerHTML = '';
            history.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${item.title}</td>
                    <td style="font-size:12px; color:#aaa;">${item.url.split('?')[0]}</td>
                    <td><button class="play-small" onclick="loadFromHistory('${item.url}')">Play</button></td>
                `;
                tableBody.appendChild(row);
            });
        }

        function clearHistory() {
            if (confirm("Clear all history?")) {
                history = [];
                localStorage.removeItem('ytHistory');
                renderHistory();
            }
        }

        function loadFromHistory(url) {
            document.getElementById('url').value = url;
            load();
        }

        function load() {
            let url = document.getElementById('url').value.trim();
            if (!url) return msg.textContent = "Enter a link!";

            if (!url.includes('http')) url = 'https://' + url;
            msg.textContent = "Connecting...";
            box.style.display = "block";
            playbtn.style.opacity = 1;
            speeds.style.display = "none";
            titleEl.textContent = "";

            fetch('/stream', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({url})
            })
            .then(r => r.json())
            .then(d => {
                if (d.error) {
                    msg.textContent = d.error;
                    box.style.display = "none";
                    return;
                }
                msg.textContent = "Ready! Click play";
                titleEl.textContent = d.title;
                vid.src = d.stream_url;
                vid.oncanplay = () => speeds.style.display = "block";

                // Save to history
                saveToHistory(d.title, url);
            })
            .catch(() => msg.textContent = "Failed. Try again.");
        }

        // Enter key
        document.getElementById('url').addEventListener('keypress', e => e.key === 'Enter' && load());

        // Big play button
        vid.onpause = () => { if (!vid.ended) playbtn.style.opacity = 1; };
        vid.onplay = () => playbtn.style.opacity = 0;
    </script>
</body>
</html>